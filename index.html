<!DOCTYPE html>

<html>
<head>
  <title>canonical-stringify.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>canonical-stringify.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-string">'use strict'</span>

ESCAPABLE = <span class="hljs-regexp">/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g</span>
gap = <span class="hljs-literal">null</span>
indent = <span class="hljs-literal">null</span>
META =
  <span class="hljs-string">'\b'</span>: <span class="hljs-string">'\\b'</span>
  <span class="hljs-string">'\t'</span>: <span class="hljs-string">'\\t'</span>
  <span class="hljs-string">'\n'</span>: <span class="hljs-string">'\\n'</span>
  <span class="hljs-string">'\f'</span>: <span class="hljs-string">'\\f'</span>
  <span class="hljs-string">'\r'</span>: <span class="hljs-string">'\\r'</span>
  <span class="hljs-string">'"'</span> : <span class="hljs-string">'\\"'</span>
  <span class="hljs-string">'\\'</span>: <span class="hljs-string">'\\\\'</span>
rep = <span class="hljs-literal">null</span>

<span class="hljs-function"><span class="hljs-title">quote</span> = <span class="hljs-params">(string)</span> -&gt;</span>
  ESCAPABLE.lastIndex = <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> ESCAPABLE.test(string)
    val = string.replace ESCAPABLE, <span class="hljs-function"><span class="hljs-params">(a)</span> -&gt;</span>
      c = META[a]
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> c == <span class="hljs-string">'string'</span>
        <span class="hljs-keyword">return</span> c
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">'\\u'</span> + (<span class="hljs-string">'0000'</span> + a.charCodeAt(<span class="hljs-number">0</span>).toString(<span class="hljs-number">16</span>)).slice(-<span class="hljs-number">4</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">'"'</span> + val + <span class="hljs-string">'"'</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'"'</span> + string + <span class="hljs-string">'"'</span>

<span class="hljs-function"><span class="hljs-title">str</span> = <span class="hljs-params">(key, holder)</span> -&gt;</span>
  mind = gap
  value = holder[key]

  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> rep == <span class="hljs-string">'function'</span>
    value = rep.call(holder, key, value)

  <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> value
    <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> quote(value)

    <span class="hljs-keyword">when</span> <span class="hljs-string">'number'</span>
      <span class="hljs-keyword">if</span> isFinite(value)
        <span class="hljs-keyword">return</span> String(value)
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">'null'</span>

    <span class="hljs-keyword">when</span> <span class="hljs-string">'boolean'</span>, <span class="hljs-string">'null'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> String(value)

    <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">'null'</span> <span class="hljs-keyword">if</span> !value

      gap += indent
      partial = []

      <span class="hljs-keyword">if</span> Object.prototype.toString.apply(value) == <span class="hljs-string">'[object Array]'</span>
        length = value.length
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..value.length]
          partial[i] = str(i, value) || <span class="hljs-string">'null'</span>

        <span class="hljs-keyword">if</span> partial.length == <span class="hljs-number">0</span>
          v = <span class="hljs-string">'[]'</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">if</span> gap
            v = <span class="hljs-string">'[\n'</span> + gap + partial.join(<span class="hljs-string">',\n'</span> + gap) + <span class="hljs-string">'\n'</span> + mind + <span class="hljs-string">']'</span>
          <span class="hljs-keyword">else</span>
            v = <span class="hljs-string">'['</span> + partial.join(<span class="hljs-string">','</span>) + <span class="hljs-string">']'</span>
        gap = mind
        <span class="hljs-keyword">return</span> v

        <span class="hljs-keyword">if</span> rep &amp;&amp; <span class="hljs-keyword">typeof</span> rep == <span class="hljs-string">'object'</span>
          length = rep.length
          <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> rep
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> k == <span class="hljs-string">'string'</span>
              v = str(k, value)
              <span class="hljs-keyword">if</span> (v)
                partial.push(quote(k) + (<span class="hljs-keyword">if</span> gap <span class="hljs-keyword">then</span> <span class="hljs-string">': '</span> <span class="hljs-keyword">else</span> <span class="hljs-string">':'</span>) + v)

      <span class="hljs-keyword">else</span> <span class="hljs-comment"># an actual Object</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Sort the objectâ€™s keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sortedKeys = Object.keys(value).sort()
        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> sortedKeys
          <span class="hljs-keyword">if</span> Object.prototype.hasOwnProperty.call(value, k)
            v = str(k, value)
            <span class="hljs-keyword">if</span> v
              partial.push(quote(k) + (<span class="hljs-keyword">if</span> gap <span class="hljs-keyword">then</span> <span class="hljs-string">': '</span> <span class="hljs-keyword">else</span> <span class="hljs-string">':'</span>) + v)

        <span class="hljs-keyword">if</span> partial.length == <span class="hljs-number">0</span>
          v = <span class="hljs-string">'{}'</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">if</span> gap
            v = <span class="hljs-string">'{\n'</span> + gap + partial.join(<span class="hljs-string">',\n'</span> + gap) + <span class="hljs-string">'\n'</span> + mind + <span class="hljs-string">'}'</span>
          <span class="hljs-keyword">else</span>
            v = <span class="hljs-string">'{'</span> + partial.join(<span class="hljs-string">','</span>) + <span class="hljs-string">'}'</span>
        gap = mind
        <span class="hljs-keyword">return</span> v

<span class="hljs-function"><span class="hljs-title">stringify</span> = <span class="hljs-params">(value, replacer, space)</span> -&gt;</span>
  gap = <span class="hljs-string">''</span>
  indent = <span class="hljs-string">''</span>

  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> space == <span class="hljs-string">'number'</span>
    indent += <span class="hljs-string">' '</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.(space -<span class="hljs-number">1</span>)]
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> space == <span class="hljs-string">'string'</span>
    indent = space

  rep = replacer
  replacerType = <span class="hljs-keyword">typeof</span> replacer
  <span class="hljs-keyword">if</span> replacer &amp;&amp; replacerType != <span class="hljs-string">'function'</span> &amp;&amp;
      (replacerType != <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> replacer.length != <span class="hljs-string">'number'</span>)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'JSON.stringify'</span>)

  <span class="hljs-keyword">return</span> str(<span class="hljs-string">''</span>, {<span class="hljs-string">''</span>: value})

<span class="hljs-keyword">if</span> <span class="hljs-built_in">module</span>? &amp;&amp; <span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span>?
  <span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = stringify
<span class="hljs-keyword">else</span>
  <span class="hljs-built_in">window</span>.canonicalStringify = stringify</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
